---
id: cert-manager
title: Injecting Certificates from Cert Manager
---

Gatekeeper controller generates by default and rotates a self signed CA and TLS certificate. The CA is injected into the admission webhooks, the TLS secret is mounted into the controller pod. This tutorial is about using [cert-manager](https://cert-manager.io/docs/) to manage the CA and the certificate.

## Generating issuers and certificates

We will create a simple self signed CA certificate with cert-manager. From this CA, we will create a certificate that we will associate to the controller.

### Issuing a CA certificate

Let's create the CA certificate for our example :

```yaml
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: gatekeeper-selfsigning-issuer
  namespace: gatekeeper-system
spec:
  selfSigned: {}
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: gatekeeper-ca-certificate
  namespace: gatekeeper-system
spec:
  secretName: gatekeeper-ca-certificate
  isCA: true
  commonName: gatekeeper-ca
  issuerRef:
    name: gatekeeper-selfsigning-issuer
```

If successful, you should have a valid certificate and an associated secret :
```
$ kubectl -n gatekeeper-system get cert gatekeeper-ca-certificate
NAME                        READY   SECRET                      AGE
gatekeeper-ca-certificate   True    gatekeeper-ca-certificate   3h6m
$ kubectl -n gatekeeper-system get secret gatekeeper-ca-certificate
NAME                        TYPE                DATA   AGE
gatekeeper-ca-certificate   kubernetes.io/tls   3      3h6m
```

You can check the content of the CA certificate as following :
```
kubectl -n gatekeeper-system get secret gatekeeper-ca-certificate -o go-template='{{index .data "ca.crt"}}' | base64 -d | openssl x509 -noout -text
```

In the real world, there is no reason why you would generate a self signed CA certificate. Tis is for te purpose of the example. The CA was most probably issued by a trusted authority at the organisation level.

### TLS certificate

Let's create now a TLS certificate for the service `gatekeeper-webhook-service` from our authority :

```yaml
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: gatekeeper-ca-issuer
  namespace: gatekeeper-system
spec:
  ca:
    secretName: gatekeeper-ca-certificate
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: gatekeeper-certificate
  namespace: gatekeeper-system
spec:
  secretName: gatekeeper-certificate
  commonName: gatekeeper-webhook-service.gatekeeper-system.svc
  issuerRef:
    name: gatekeeper-ca-issuer
    name: gatekeeper-selfsigning-issuer
    kind: Issuer
```

If successful, you should have a valid certificate and a related TLS secret similar to :
```
$ kubectl -n gatekeeper-system get cert gatekeeper-certificate
NAME                     READY   SECRET                   AGE
gatekeeper-certificate   True    gatekeeper-certificate   3h9m
$ kubectl -n gatekeeper-system get secret gatekeeper-certificate
NAME                     TYPE                DATA   AGE
gatekeeper-certificate   kubernetes.io/tls   3      3h8m
```

You can check the content of the generated certificate :
```
kubectl -n gatekeeper-system get secret gatekeeper-certificate -o go-template='{{index .data "tls.crt"}}' | base64 -d | openssl x509 -noout -text
```

## Configure the helm chart parameters

The helm chart generates automatically a self signed certificate (`gatekeeper-webhook-server-cert`) by default. This has to be disabled to pass the generated secret (here `gatekeeper-certificate`).

```yaml
certificates:
    generate: false
    secretName: gatekeeper-certificate
```

*Warning* : Not disabling the genration of certifictes will genrate a race condition between the cert-manager and the controller : both manage the `caBundle` value of the webhooks. The `metadata.generation` of the webhooks will quickly increment with potentialy no evident change.

We annotate the admission webhooks with [`cainjector` from cert-manager](https://cert-manager.io/docs/concepts/ca-injector/) to configure the CABundle with our CA certificate.

This can be done with the parameters `validatingWebhookAnnotations` and `mutatingWebhookAnnotations`. Here, we pass the name of the certificate we have created to the validating webhook. A secret storing the CA can also be used.

```yaml
validatingWebhookAnnotations:
    cert-manager.io/inject-ca-from: gatekeeper-system/gatekeeper-ca-certificate
```

The `certificates.secretName` is used to mount the secret storing the TLS cert that was generated by cert-manager.

## Check the injection

The CABundles injected in the webhook must be identical to the CA certificate stored in the related secret :

```
kubectl -n gatekeeper-system get secret gatekeeper-ca-certificate -o go-template='{{index .data "ca.crt"}}'
```

```
kubectl get validatingWebhookConfiguration gatekeeper-validating-webhook-configuration -o go-template='{{range .webhooks }}{{ printf "%s\n" .clientConfig.caBundle }}{{ end }}'
```

The three values must be identical.

